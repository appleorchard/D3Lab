<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Single Column Chart</title>
    <script src="../libs/underscore/underscore-min.js"></script>
    <script src="../libs/d3/d3.min.js"></script>
    <script src="../js/d3lab.js"></script>

    <style>
        svg {
            font: 10px sans-serif;
            shape-rendering: crispEdges;
        }

        /*rect {*/
        /*fill: #ddd;*/
        /*}*/

        .axis path,
        .axis line {
            fill: none;
            stroke: black;
            shape-rendering: crispEdges;
        }

        .axis text {
            font-family: sans-serif;
            font-size: 11px;
        }

        rect {
            -webkit-transition: all 0.3s;
            -moz-transition: all 0.3s;
            -ms-transition: all 0.3s;
            -o-transition: all 0.3s;
            transition: all 0.3s;
        }

        rect:hover {
            fill: orange;
        }

        svg text {
            pointer-events: none;
        }

        #tooltip {
            position: absolute;
            width: 200px;
            height: auto;
            padding: 10px;
            background-color: white;
            -webkit-border-radius: 10px;
            -moz-border-radius: 10px;
            border-radius: 10px;
            -webkit-box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);
            -moz-box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);
            box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);
            pointer-events: none;
        }

        #tooltip.hidden {
            display: none;
        }

        #tooltip p {
            margin: 0;
            font-family: sans-serif;
            font-size: 16px;
            line-height: 20px;
            font-weight: bold;
        }
    </style>
</head>
<body>
<p id="changeData">Change Dataset!</p>

<p id="add">Add</p>

<p id="delete">Delete</p>

<div id="tooltip" class="hidden">
    <p><strong>Important Label Heading</strong></p>

    <p><span id="value">100</span>%</p>
</div>


<script>

    (function () {
        var dataset = d3lab.repeatedly(20, d3lab.singleRandomData(25));

        var margin = {top: 20, right: 10, bottom: 20, left: 100};
        var width = 500 - margin.left - margin.right,
                height = 500 - margin.top - margin.bottom;

        var xscale = d3.scale.ordinal()
                .domain(d3.range(dataset.length))
                .rangeRoundBands([0, width], 0.05);

        var yscale = d3.scale.linear()
                .domain([0, d3.max(dataset)])
                .range([height, 0])
                .clamp(true);

        var zoom = d3.behavior.zoom()
                .y(yscale)
                .scaleExtent([0, 1.5])
                .on('zoom', function () {
                    svg.selectAll('rect')
                            .attr('x', function (d, i) {
                                return xscale(i);
                            })
                            .attr('y', function (d) {
                                return yscale(d);
                            })
                            .attr('width', function (d) {
                                return xscale.rangeBand();
                            })
                            .attr('height', function (d) {
                                return height - yscale(d);
                            });

                    svg.select(".x.axis").call(xaxis);
                    svg.select(".y.axis").call(yaxis);
                });

        var svg = d3.select('body').append('svg')
                .attr('width', width + margin.left + margin.right)
                .attr('height', height + margin.top + margin.bottom)
                .append('g')
                .attr('transform', 'translate(' + [margin.left, margin.top] + ')')
                .call(zoom);

        svg.selectAll('rect')
                .data(dataset)
                .enter()
                .append('rect')
                .attr('x', function (d, i) {
                    return xscale(i);
                })
                .attr('y', function (d) {
                    return yscale(d);
                })
                .attr('width', function (d) {
                    return xscale.rangeBand();
                })
                .attr('height', function (d) {
                    return height - yscale(d);
                })
                .attr('fill', 'teal')
                .on('mouseover', function (d) {

                    console.log(d3.mouse(this));
                    console.log(d3.event.clientX);

                    var xPosition = d3.event.clientX + 10;
                    var yPosition = d3.event.clientY;
//                    var xPosition = parseFloat(d3.select(this).attr('x')) + xscale.rangeBand() / 2;
//                    var yPosition = parseFloat(d3.select(this).attr('y')) / 2 + height / 2;

                    d3.select('#tooltip')
                            .style('left', xPosition + 'px')
                            .style('top', yPosition + 'px')
                            .select('#value')
                            .text(d);

                    d3.select('#tooltip').classed('hidden', false);

                    /* SVG Tooltip create */
//                    var xPosition = parseFloat(d3.select(this).attr('x')) + xscale.rangeBand() / 2;
//                    var yPosition = parseFloat(d3.select(this).attr('y')) + 14;
//
//                    svg.append('text')
//                            .attr('id', 'tooltip')
//                            .attr('x', xPosition)
//                            .attr('y', yPosition)
//                            .attr('text-anchor', 'middle')
//                            .attr('font-family', 'sans-serif')
//                            .attr('font-size', '11px')
//                            .attr('font-weight', 'bold')
//                            .text(d);
                })
                .on('mouseout', function () {
                    d3.select('#tooltip').classed('hidden', true);

                    /* SVG Tooltip destroy */
//                    d3.select('#tooltip').remove();
                })
                .on('click', function () {
                    sortBars();
                })
                .append('title')
                .text(function (d) {
                    return 'This value is ' + d;
                });

        var sortOrder = false;
        var sortBars = function () {

            sortOrder = !sortOrder;

            svg.selectAll('rect')
                    .sort(function (a, b) {

                        if (sortOrder) {
                            return d3.ascending(a, b);
                        } else {
                            return d3.descending(a, b);
                        }
                    })
                    .transition()
                    .duration(1000)
                    .attr('x', function (d, i) {
                        return xscale(i);
                    });
        };


        var xaxis = d3.svg.axis()
                .scale(xscale)
                .orient('bottom')
                .tickSize(-height, 10);

        var yaxis = d3.svg.axis()
                .scale(yscale)
                .orient('left')
                .tickSize(-width, 10);

        svg.append('g')
                .attr('class', 'x axis')
                .attr('transform', 'translate(' + [0, height] + ')')
                .call(xaxis);

        svg.append('g')
                .attr('class', 'y axis')
                .call(yaxis)


        d3.selectAll('p')
                .on('click', function () {

                    var command = d3.select(this).attr('id');
                    console.log(command);

                    if (command === 'changeData') {
                        dataset = d3lab.repeatedly(20, d3lab.singleRandomData(25));

                        svg.selectAll('rect')
                                .data(dataset)
                                .enter()
                                .append('rect')
                                .attr('x', function (d, i) {
                                    return width;
                                })
                                .attr('y', function (d) {
                                    return yscale(d);
                                })
                                .attr('width', function (d) {
                                    return xscale.rangeBand();
                                })
                                .attr('height', function (d) {
                                    return height - yscale(d);
                                })
                                .attr('fill', 'teal');
                    } else if (command === 'add') {
                        var addData = Math.floor(Math.random() * (25 + 1));
                        dataset.push(addData);

                        svg.selectAll('rect')
                                .data(dataset)
                                .enter()
                                .append('rect')
                                .attr('x', function (d, i) {
                                    return width;
                                })
                                .attr('y', function (d) {
                                    return yscale(d);
                                })
                                .attr('width', function (d) {
                                    return xscale.rangeBand();
                                })
                                .attr('height', function (d) {
                                    return height - yscale(d);
                                })
                                .attr('fill', 'teal');

                    } else if (command === 'delete') {
                        dataset.shift();

                        svg.selectAll('rect')
                                .data(dataset)
                                .exit()
                                .transition()
                                .duration(500)
                                .attr('x', width)
                                .remove();
                    }

                    xscale.domain(d3.range(dataset.length));
                    yscale.domain([0, d3.max(dataset)]);

                    // Update
                    svg.selectAll('rect')
                            .data(dataset)
                            .transition()
                            .duration(500)
                            .attr('x', function (d, i) {
                                return xscale(i);
                            })
                            .attr('y', function (d) {
                                return yscale(d);
                            })
                            .attr('width', function (d) {
                                return xscale.rangeBand();
                            })
                            .attr('height', function (d) {
                                return height - yscale(d);
                            });

                    svg.select('.x.axis')
                            .transition()
                            .duration(500)
                            .call(xaxis);

                    svg.select('.y.axis')
                            .transition()
                            .duration(500)
                            .call(yaxis);
                });
    })();
</script>
</body>
</html>